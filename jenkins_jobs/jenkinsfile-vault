def buildType
pipeline {
    agent {
        node {
            label 'slave'
        }
    }
    parameters {
        string description: 'Organization name of the node', name: 'org_name', trim: true
        string description: 'Environment (dev | test | prod)', name: 'env', trim: true
        choice choices: ['setup', 'cleanup'], description: 'Choose setup/clean vault instance', name: 'action'
        }
    stages {
        stage('Prepare') {
            steps {
                script {
                    if( "${params.action}" == "setup") {
                        buildType = "${params.action}"
                        setupVault(buildType)
                    } else {
                        buildType = "${params.action}"
                        cleanupVault(buildType)
                    }
                }
            }
        }
    }
    post {
        success {
            echo "The BAF action: ${params.action} action is successful. Review logs for details"
        }
        failure {
            echo "The BAF action: ${params.action} is failed, Please investigate"
        }
    }
}
def setupVault(){
    stage('DeployVault') {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
            ansibleTower(
                towerServer: 'AWX',
                towerCredentialsId: 'AWX',
                templateType: 'job',
                jobTemplate: '${params.org_name}-${params.env}-openidl-vault-deploy',
                jobType: "run",
                towerLogLevel: 'full',
                removeColor: false,
                async: false,
                importTowerLogs: true,
                credential: '${params.org_name}-${params.env}-openidl-iac',
                extraVars: """---
                org_name: '${params.org_name}'
                env: '${params.env}'
                """
            )
        }
    }
}
def cleanupVault(){
    stage('CleanupVault') {
        wrap([$class: 'AnsiColorBuildWrapper', colorMapName: "xterm"]) {
            ansibleTower(
                towerServer: 'AWX',
                towerCredentialsId: 'AWX',
                templateType: 'job',
                jobTemplate: '${params.org_name}-${params.env}-openidl-vault-cleanup',
                jobType: "run",
                towerLogLevel: 'full',
                removeColor: false,
                async: false,
                importTowerLogs: true,
                credential: '${params.org_name}-${params.env}-openidl-iac',
                extraVars: """---
                org_name: '${params.org_name}'
                env: '${params.env}'
                """
            )
        }
    }
}



