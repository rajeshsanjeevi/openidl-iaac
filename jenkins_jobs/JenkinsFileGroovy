#!groovy
import groovy.json.JsonOutput
import groovy.json.JsonSlurper
node {
    def url =
    checkout()
    prepareAWSCode()
    buildAWSInfra()
}
def checkout() {
    stage('Clone') {
        git credentialsId: 'github', branch: "${params.GITHUB_BRANCH}", url: 'https://github.com/rajeshsanjeevi/openidl-iaac.git'
    }
}
def prepareAWSCode() {
    sh '''
        cp ./aws/carrier.tfvars ./aws/aws_resources/carrier.auto.tfvars
        tar -czf aws-content.tar.gz -C aws/aws_resources --exclude .git .
        echo "Successfully prepared the AWS resources code bundle"
    '''
 }
def buildAWSInfra() {
    stage('AWS-TFPlan') {
        getWorkspaceId()
        createConfig()
    }
}
def getWorkspaceId() {
    def response = httpRequest(
        customHeaders: [
                [ name: "Authorization", value: "Bearer " + "${params.TF_BEARER_TOKEN}" ],
                [ name: "Content-Type", value: "application/vnd.api+json" ]
            ],
        url: "https://app.terraform.io/api/v2/organizations/" + "${params.TF_ORGNAME}" + "/workspaces/" + "${params.TF_AWS_WORKSPACE}"
    )
    def data = new JsonSlurper().parseText(response.content)
    println ("Workspace Id: " + data.data.id)
    return data.data.id
}
def createConfig() {
    def wsid = getWorkspaceId()
    def payload = """
{
  "data": {
    "type": "configuration-versions",
    "attributes": {
      "auto-queue-runs": false
    }
  }
}
    """
     def response = httpRequest(
        customHeaders: [
                [ name: "Authorization", value: "Bearer " + "${params.TF_BEARER_TOKEN}" ],
                [ name: "Content-Type", value: "application/vnd.api+json" ]
            ],
        httpMode: 'POST',
        requestBody: '$payload', 
        url: "https://app.terraform.io/api/v2/workspaces/" + "${wsid}" + "/configuration-versions"
    )
    def data = new JsonSlurper().parseText(response.content)
    println ("Config Version: " + data.data.id)
    def upload_url = data.data.attributes."upload-url"
    println ("Upload URL: " + data.data.attributes."upload-url")
    return data.data.id
}
